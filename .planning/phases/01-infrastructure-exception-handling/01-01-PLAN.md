---
phase: 01-infrastructure-exception-handling
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - aadap/core/exceptions.py
  - aadap/db/models.py
  - aadap/core/config.py
  - alembic/versions/003_add_infra_models.py
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-03
  - INFRA-04
  - INFRA-05
must_haves:
  truths:
    - "TaskLog records can be created with task_id, level, message, correlation_id"
    - "CostRecord records can be created with task_id, agent_type, tokens, cost"
    - "PlatformConnection records store encrypted platform configs"
    - "Database URL default contains placeholder, not actual credentials"
    - "Exception taxonomy exists with category-based classes and severity property"
  artifacts:
    - path: "aadap/core/exceptions.py"
      provides: "Centralized exception taxonomy with AADAPError base, severity enum"
      min_lines: 50
    - path: "aadap/db/models.py"
      provides: "TaskLog, CostRecord, PlatformConnection models"
      contains: ["class TaskLog", "class CostRecord", "class PlatformConnection"]
    - path: "aadap/core/config.py"
      provides: "Secure credential handling"
      not_contains: "parth1806"
    - path: "alembic/versions/003_add_infra_models.py"
      provides: "Database migration for new models"
      contains: "def upgrade()"
  key_links:
    - from: "aadap/core/exceptions.py"
      to: "ErrorSeverity enum"
      via: "class definition"
    - from: "aadap/db/models.py"
      to: "Task model"
      via: "ForeignKey relationship"
---

<objective>
Create foundational infrastructure: centralized exception taxonomy and three new database models (TaskLog, CostRecord, PlatformConnection). Remove hardcoded credentials from config.py and generate Alembic migration.

Purpose: Establish database foundation for logging, cost tracking, and platform settings features; provide exception types for consistent error handling across the platform.
Output: Exception taxonomy module, database models, secure config, migration file.
</objective>

<execution_context>
@C:/Users/parth/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/parth/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-exception-handling/01-CONTEXT.md
@.planning/phases/01-infrastructure-exception-handling/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md

@aadap/db/models.py
@aadap/core/config.py
@aadap/core/logging.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized exception taxonomy</name>
  <files>aadap/core/exceptions.py</files>
  <action>
Create `aadap/core/exceptions.py` with a hybrid exception hierarchy following user decision from CONTEXT.md.

Create the following structure:
1. `ErrorSeverity` StrEnum: LOW, MEDIUM, HIGH, CRITICAL (matches existing RiskLevel pattern)
2. `AADAPError` base class with:
   - `severity: ErrorSeverity = ErrorSeverity.MEDIUM`
   - `error_code: str = "AADAP_ERROR"`
   - Constructor accepts: `message`, `task_id`, `agent_id`, `correlation_id` (all optional kwargs)
   - Stores identifiers as instance attributes for tracing
3. Category-based exception classes inheriting from AADAPError:
   - `OrchestratorError` (error_code="ORCHESTRATOR_ERROR")
   - `AgentLifecycleError` (error_code="AGENT_LIFECYCLE_ERROR")
   - `IntegrationError` (error_code="INTEGRATION_ERROR")
   - `ExecutionError` (error_code="EXECUTION_ERROR")
   - `ConfigurationError` (error_code="CONFIGURATION_ERROR")
4. Specific subclasses with appropriate severity:
   - `GraphExecutionError(OrchestratorError)` with severity=HIGH
   - `RoutingError(OrchestratorError)` with severity=MEDIUM
   - `ValidationFailedError(ExecutionError)` with severity=MEDIUM

Follow existing exception patterns in `aadap/safety/approval_engine.py` (ApprovalRequiredError, etc.).
Do NOT include user-facing messages â€” technical details only (traceback, error code, timestamp, identifiers).
  </action>
  <verify>
python -c "from aadap.core.exceptions import AADAPError, OrchestratorError, ErrorSeverity; e = OrchestratorError('test', task_id='abc'); assert e.error_code == 'ORCHESTRATOR_ERROR'; assert e.severity == ErrorSeverity.MEDIUM"
  </verify>
  <done>
Exception taxonomy exists with ErrorSeverity enum, AADAPError base class with severity and error_code properties, and category-based subclasses (OrchestratorError, AgentLifecycleError, IntegrationError, ExecutionError, ConfigurationError) with specific error codes.
</done>
</task>

<task type="auto">
  <name>Task 2: Add TaskLog, CostRecord, PlatformConnection models</name>
  <files>aadap/db/models.py</files>
  <action>
Extend `aadap/db/models.py` with three new SQLAlchemy models following existing patterns (UUID PK, JSONB metadata, UTC timestamps, indexes).

1. **TaskLog model** (INFRA-01):
   - `id`: UUID primary key
   - `task_id`: UUID FK to tasks.id with CASCADE delete
   - `level`: String(16) - DEBUG, INFO, WARNING, ERROR
   - `message`: Text
   - `correlation_id`: String(64), nullable
   - `created_at`: DateTime(timezone=True)
   - Index on task_id and created_at

2. **CostRecord model** (INFRA-02):
   - `id`: UUID primary key
   - `task_id`: UUID FK to tasks.id with CASCADE delete
   - `agent_type`: String(32) - orchestrator, developer, validation, optimizer
   - `tokens_in`: Integer
   - `tokens_out`: Integer
   - `cost_usd`: Numeric(10, 6) for precision
   - `created_at`: DateTime(timezone=True)
   - Index on task_id and created_at

3. **PlatformConnection model** (INFRA-03):
   - `id`: UUID primary key
   - `platform`: String(32) - databricks or fabric
   - `name`: String(128) - human-readable name
   - `config`: JSONB - encrypted connection config (will be encrypted at application level)
   - `is_active`: Boolean, default True
   - `created_at`, `updated_at`: DateTime(timezone=True)
   - Index on platform and is_active

Use existing `_utcnow()` helper and `Base` class. Follow Task model pattern for timestamps.
Add relationships to Task model for task_logs, cost_records (optional, for eager loading).
  </action>
  <verify>
python -c "from aadap.db.models import TaskLog, CostRecord, PlatformConnection; assert hasattr(TaskLog, 'task_id'); assert hasattr(CostRecord, 'cost_usd'); assert hasattr(PlatformConnection, 'platform')"
  </verify>
  <done>
TaskLog, CostRecord, and PlatformConnection models defined with proper columns, foreign keys, indexes, and timestamps following existing model patterns.
</done>
</task>

<task type="auto">
  <name>Task 3: Remove hardcoded credentials and create migration</name>
  <files>aadap/core/config.py, alembic/versions/003_add_infra_models.py</files>
  <action>
**Part A: Fix config.py (INFRA-04)**
In `aadap/core/config.py` line 51-52, replace the hardcoded database URL:
- Change: `SecretStr("postgresql+asyncpg://parth:parth1806@localhost:5432/bionic")`
- To: `SecretStr("postgresql+asyncpg://your_user:your_password@localhost:5432/aadap")`

This is a placeholder that must be overridden via AADAP_DATABASE_URL environment variable.

**Part B: Create Alembic migration (INFRA-05)**
Create `alembic/versions/003_add_infra_models.py` following pattern from existing migrations:
- Import new models (TaskLog, CostRecord, PlatformConnection)
- `upgrade()`: Create all three tables with columns, indexes, foreign keys
- `downgrade()`: Drop all three tables in reverse order

Follow the pattern in `alembic/versions/002_add_risk_level_and_resources.py` for structure.
Use `op.create_table()` for each model with proper column definitions.
Include `op.create_index()` for all defined indexes.
  </action>
  <verify>
cd D:/bionics && python -c "from aadap.core.config import get_settings; s = get_settings(); assert 'your_password' in s.database_url.get_secret_value() or 'AADAP_DATABASE_URL' in str(type(s.database_url))"
cd D:/bionics && python -c "import alembic.config; from alembic import command; cfg = alembic.config.Config('alembic.ini'); command.check(cfg)" 2>&1 | head -5
  </verify>
  <done>
config.py has placeholder database URL (no actual credentials). Alembic migration 003 exists with upgrade/downgrade for TaskLog, CostRecord, PlatformConnection tables.
</done>
</task>

</tasks>

<verification>
1. Exception taxonomy imports correctly and has all required classes
2. Database models import correctly with proper column types
3. Config.py contains no actual credentials
4. Alembic migration validates with `alembic check`
</verification>

<success_criteria>
- `from aadap.core.exceptions import AADAPError, OrchestratorError, ErrorSeverity` succeeds
- TaskLog, CostRecord, PlatformConnection models exist in models.py with proper FKs and indexes
- No hardcoded credentials in config.py defaults
- Migration file exists with upgrade/downgrade functions
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-exception-handling/01-01-SUMMARY.md`
</output>
