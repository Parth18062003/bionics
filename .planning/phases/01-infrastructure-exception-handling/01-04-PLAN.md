---
phase: 01-infrastructure-exception-handling
plan: "04"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - aadap/safety/approval_engine.py
  - aadap/api/routes/approvals.py
autonomous: true
requirements:
  - EXCPT-07
must_haves:
  truths:
    - "approval_engine.py has no sync wrapper methods (no *_sync functions)"
    - "All callers use async approval methods"
    - "ThreadPoolExecutor no longer used in approval engine"
    - "API routes call async methods directly with await"
  artifacts:
    - path: "aadap/safety/approval_engine.py"
      provides: "Approval engine with async-only API"
      not_contains: ["def approve_sync", "def reject_sync", "ThreadPoolExecutor"]
    - path: "aadap/api/routes/approvals.py"
      provides: "Approval API routes using async methods"
      contains: "await engine.approve"
  key_links:
    - from: "aadap/api/routes/approvals.py"
      to: "aadap/safety/approval_engine.py"
      via: "await engine.approve"
    - from: "approval_engine.py"
      to: "async methods"
      via: "removed sync wrappers"
---

<objective>
Remove ThreadPoolExecutor sync wrappers from approval_engine.py and update all callers to use async methods. Standardize on async-only API.

Purpose: Eliminate thread pool exhaustion risk and potential deadlocks from sync wrappers in async code. Simplify codebase by having single async API.
Output: Approval engine with async-only methods, updated callers.
</objective>

<execution_context>
@C:/Users/parth/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/parth/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-infrastructure-exception-handling/01-CONTEXT.md
@.planning/phases/01-infrastructure-exception-handling/01-RESEARCH.md
@.planning/phases/01-infrastructure-exception-handling/01-01-SUMMARY.md

@aadap/safety/approval_engine.py
@aadap/api/routes/approvals.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove sync wrapper methods from approval_engine.py (EXCPT-07)</name>
  <files>aadap/safety/approval_engine.py</files>
  <action>
Remove all sync wrapper methods from `aadap/safety/approval_engine.py`.

**Methods to DELETE (lines 309-338 and 668-777):**
1. `request_approval` (lines 309-338) - sync wrapper for `request_approval_async`
2. `approve_sync` (lines 670-692)
3. `reject_sync` (lines 694-716)
4. `check_expired_sync` (lines 718-739)
5. `get_record_sync` (lines 741-758)
6. `enforce_approval_sync` (lines 760-777)

**Changes:**
1. Delete all six sync wrapper methods entirely
2. Remove `import concurrent.futures` if no longer used elsewhere
3. Remove `import asyncio` if only used in sync wrappers (but keep if used elsewhere)
4. Keep all async methods unchanged:
   - `request_approval_async`
   - `approve`
   - `reject`
   - `check_expired`
   - `get_record`
   - `enforce_approval`

**Note:** The sync wrappers use ThreadPoolExecutor to bridge async/sync contexts. This causes:
- Thread pool exhaustion under load
- Potential deadlocks when called from async context
- Unnecessary complexity

All callers should use async methods directly. FastAPI routes are already async, so this is a straightforward migration.
  </action>
  <verify>
cd D:/bionics && grep -c "_sync" aadap/safety/approval_engine.py
cd D:/bionics && grep -c "ThreadPoolExecutor" aadap/safety/approval_engine.py
  </verify>
  <done>
approval_engine.py has no sync wrapper methods. Only async methods (approve, reject, check_expired, get_record, enforce_approval, request_approval_async) remain. No ThreadPoolExecutor usage.
</done>
</task>

<task type="auto">
  <name>Task 2: Update all callers to use async methods</name>
  <files>aadap/api/routes/approvals.py</files>
  <action>
Find and update all callers of removed sync methods to use async versions.

**Search pattern:**
```bash
grep -r "approve_sync\|reject_sync\|get_record_sync\|check_expired_sync\|enforce_approval_sync\|request_approval(" --include="*.py" aadap/
```

**Expected updates in aadap/api/routes/approvals.py:**
1. `approve_sync` -> `await engine.approve`
2. `reject_sync` -> `await engine.reject`
3. `get_record_sync` -> `await engine.get_record`

**Pattern for updates:**
```python
# Before
result = engine.approve_sync(approval_id, decided_by, reason)

# After
result = await engine.approve(approval_id, decided_by, reason)
```

**If sync methods called from non-async context:**
- FastAPI route handlers should already be async
- If truly needed in sync context, caller should use `asyncio.run()` at entry point

**Additional files to check:**
- aadap/api/routes/*.py (all route files)
- Any test files that mock approval engine

Ensure all imports still work after removing sync methods.
  </action>
  <verify>
cd D:/bionics && grep -r "approve_sync\|reject_sync\|_sync" --include="*.py" aadap/ | grep -v "__pycache__" | wc -l
  </verify>
  <done>
All callers use async methods. No references to removed sync wrappers exist in codebase. API routes work correctly with async approval methods.
</done>
</task>

</tasks>

<verification>
1. `grep -c "_sync" aadap/safety/approval_engine.py` returns 0
2. `grep -c "ThreadPoolExecutor" aadap/safety/approval_engine.py` returns 0
3. `grep -r "approve_sync\|reject_sync" --include="*.py" aadap/` returns empty
4. Python imports succeed: `from aadap.safety.approval_engine import ApprovalEngine, get_approval_engine`
</verification>

<success_criteria>
- No sync wrapper methods in approval_engine.py
- No ThreadPoolExecutor usage in approval_engine.py
- All callers updated to use async methods
- API approval routes work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-exception-handling/01-04-SUMMARY.md`
</output>
