---
phase: 02-chatbot
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: []
autonomous: true
requirements: [CHAT-04, CHAT-05, CHAT-06]

must_haves:
  truths:
    - "User can access chat from dedicated /chat page"
    - "User can open slide-out chat panel from any page"
    - "User sees extracted requirements in side panel with field-level indicators"
    - "User can create task when requirements are complete"
  artifacts:
    - path: "frontend/src/app/chat/page.tsx"
      provides: "Dedicated chat page with split view"
      contains: "ChatPage"
    - path: "frontend/src/components/chat/ChatPanel.tsx"
      provides: "Slide-out chat panel component"
      contains: "ChatPanel"
    - path: "frontend/src/components/chat/RequirementsPanel.tsx"
      provides: "Requirements extraction display with editing"
      contains: "RequirementsPanel"
    - path: "frontend/src/components/chat/ChatMessage.tsx"
      provides: "Individual chat message display"
      contains: "ChatMessage"
  key_links:
    - from: "frontend/src/app/chat/page.tsx"
      to: "/api/chat"
      via: "fetch + SSE EventSource"
      pattern: "EventSource|fetch.*chat"
    - from: "frontend/src/components/chat/ChatPanel.tsx"
      to: "/api/chat"
      via: "shared chat hooks"
      pattern: "useChat"
    - from: "frontend/src/components/chat/RequirementsPanel.tsx"
      to: "PATCH /api/chat/sessions/{id}/requirements"
      via: "direct edit API"
      pattern: "PATCH.*requirements"
---

<objective>
Create the chat frontend with dedicated page, slide-out panel, and requirements confirmation UI.

Purpose: Provide intuitive chat interface for task creation with live requirement extraction.
Output: Chat page, slide-out panel, requirements panel component, and integration with backend.
</objective>

<execution_context>
@C:/Users/parth/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/parth/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chatbot/02-CONTEXT.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat hooks and types</name>
  <files>frontend/src/hooks/useChat.ts, frontend/src/types/chat.ts</files>
  <action>
    Create TypeScript types and React hooks for chat functionality:
    
    1. **Types (frontend/src/types/chat.ts)**:
       ```typescript
       type Role = 'user' | 'assistant' | 'system';
       
       interface FieldWithConfidence {
         value: string | null;
         confidence: number; // 0.0-1.0
       }
       
       interface ExtractedRequirements {
         task_name: FieldWithConfidence;
         description: FieldWithConfidence;
         target_table: FieldWithConfidence;
         objective: FieldWithConfidence;
         success_criteria: FieldWithConfidence;
         constraints: FieldWithConfidence;
         overall_confidence: number;
         is_complete: boolean;
       }
       
       interface ChatMessage {
         role: Role;
         content: string;
         timestamp: string;
         extracted_requirements?: ExtractedRequirements;
       }
       
       interface ChatSession {
         session_id: string;
         messages: ChatMessage[];
         created_at: string;
         updated_at: string;
         current_requirements: ExtractedRequirements | null;
       }
       ```
    
    2. **useChat hook (frontend/src/hooks/useChat.ts)**:
       - `session: ChatSession | null` — Current session state
       - `isLoading: boolean` — Streaming in progress
       - `error: string | null` — Error message
       - `createSession(): Promise<void>` — Start new session
       - `sendMessage(content: string): Promise<void>` — Send and stream response
       - `updateRequirements(req: Partial<ExtractedRequirements>): Promise<void>` — Direct edit
       - `createTask(): Promise<{ task_id: string }>` — Create task from requirements
       
       Use EventSource API for SSE streaming. Parse events and update local state.
       Store session_id in localStorage for page refresh recovery.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit src/hooks/useChat.ts src/types/chat.ts 2>&1 | head -20`
  </verify>
  <done>
    Chat types and useChat hook exist. Hook handles session creation, SSE streaming, requirements updates, and task creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chat message and requirements panel components</name>
  <files>frontend/src/components/chat/ChatMessage.tsx, frontend/src/components/chat/RequirementsPanel.tsx</files>
  <action>
    Create reusable chat UI components:
    
    1. **ChatMessage.tsx**:
       - Props: `message: ChatMessage`
       - Display message content with role-based styling:
         - User: right-aligned, blue background
         - Assistant: left-aligned, gray background
       - Show timestamp in small muted text
       - Use Tailwind for styling
       - Support markdown rendering for assistant messages (use react-markdown or similar)
    
    2. **RequirementsPanel.tsx**:
       - Props: `requirements: ExtractedRequirements | null`, `onUpdate: (req) => void`, `onCreateTask: () => void`
       - **Progressive disclosure**:
         - Core fields always visible: task_name, description, target_table, objective
         - Expandable section: success_criteria, constraints (collapsed by default)
       - **Field-level indicators**:
         - Red asterisk or warning icon (⚠) next to incomplete fields
         - Confidence bar or percentage next to each field
         - Gray out fields with low confidence
       - **Editing**:
         - Each field is an editable input (not just display)
         - On blur, call onUpdate with new value
         - Direct edits set confidence to 1.0 (user-confirmed)
       - **Create Task button**:
         - Disabled if `!requirements?.is_complete`
         - Show tooltip: "Complete all required fields" when disabled
       - Use existing UI components from frontend/src/components/ui/ if available (shadcn/ui pattern)
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit src/components/chat/ChatMessage.tsx src/components/chat/RequirementsPanel.tsx 2>&1 | head -20`
  </verify>
  <done>
    ChatMessage and RequirementsPanel components exist. ChatMessage renders messages with role styling. RequirementsPanel shows progressive disclosure with field-level indicators and editable fields.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create dedicated chat page with split view</name>
  <files>frontend/src/app/chat/page.tsx, frontend/src/components/chat/ChatInput.tsx</files>
  <action>
    Create the dedicated /chat page:
    
    1. **ChatInput.tsx component**:
       - Props: `onSend: (message: string) => void`, `disabled: boolean`
       - Textarea with auto-resize (max 4 rows)
       - Send button (paper airplane icon)
       - Enter to send, Shift+Enter for newline
       - Disabled state when streaming
    
    2. **page.tsx (split view layout)**:
       - Use useChat hook for state management
       - Create session on mount if not exists
       - **Layout** (per CONTEXT.md decision):
         - Left side (60%): Chat message history + input at bottom
         - Right side (40%): RequirementsPanel (sticky)
         - Mobile: Stack vertically (chat on top, requirements below)
       - Auto-scroll chat to bottom on new messages
       - Show loading skeleton while session loads
       - Header with "New Chat" button to reset session
       - After task creation, show success modal with options:
         - "View Task" → navigate to /tasks/{task_id}
         - "Create Another" → reset session, start fresh
         - "Continue Chatting" → close modal, keep session
    
    Use Tailwind responsive classes for mobile handling.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit src/app/chat/page.tsx 2>&1 | head -20`
  </verify>
  <done>
    /chat page exists with split view layout. Chat on left, requirements panel on right. User can have multi-turn conversation and see requirements update in real-time.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create slide-out chat panel component</name>
  <files>frontend/src/components/chat/ChatPanel.tsx, frontend/src/components/layout/ChatTrigger.tsx</files>
  <action>
    Create slide-out panel accessible from any page:
    
    1. **ChatTrigger.tsx**:
       - Floating action button (FAB) in bottom-right corner
       - Chat bubble icon
       - Tooltip: "Open chat"
       - Click opens ChatPanel
       - Show badge if panel is open
       - Add to main layout (frontend/src/app/layout.tsx or shared layout component)
    
    2. **ChatPanel.tsx**:
       - Slide-out panel from right side
       - Use existing Sheet/Drawer component if available (shadcn/ui)
       - **Content**:
         - Compact header with close button
         - Chat messages (scrollable, max-height)
         - ChatInput at bottom
         - No requirements panel (panel mode is quick-chat only)
       - **Behavior**:
         - Open/close with smooth animation
         - Persist session across panel opens
         - Close on escape key
         - Click outside to close (optional)
       - **Width**: ~400px on desktop, full-width on mobile
       
    This provides quick chat access from anywhere in the app.
    Panel uses same useChat hook for session management.
  </action>
  <verify>
    `cd frontend && npx tsc --noEmit src/components/chat/ChatPanel.tsx src/components/layout/ChatTrigger.tsx 2>&1 | head -20`
  </verify>
  <done>
    ChatTrigger FAB exists in layout. ChatPanel slides out from right with chat interface. User can chat from any page without navigating away.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete chat frontend with dedicated page (/chat), slide-out panel, and requirements panel</what-built>
  <how-to-verify>
    1. Run `cd frontend && npm run dev`
    2. Navigate to http://localhost:3000/chat
    3. Send a message like "I need to create a data pipeline for customer data"
    4. Verify streaming response appears
    5. Verify requirements panel updates with extracted fields
    6. Edit a field directly in the requirements panel
    7. Test the slide-out panel from the main page
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. /chat page renders with split view
3. Chat messages stream from backend via SSE
4. Requirements panel updates during conversation
5. Field-level indicators show for incomplete fields
6. Slide-out panel opens from FAB trigger
7. Task creation works with complete requirements
</verification>

<success_criteria>
- [ ] Chat types and useChat hook exist
- [ ] ChatMessage component renders with role styling
- [ ] RequirementsPanel shows progressive disclosure with field indicators
- [ ] /chat page has split view layout (chat left, requirements right)
- [ ] ChatInput handles Enter to send, Shift+Enter for newline
- [ ] ChatTrigger FAB in layout
- [ ] ChatPanel slides out from right
- [ ] SSE streaming works with EventSource
- [ ] Task creation shows success options
</success_criteria>

<output>
After completion, create `.planning/phases/02-chatbot/02-02-SUMMARY.md`
</output>
