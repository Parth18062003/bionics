---
phase: 04-code-editor
plan: "02"
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - frontend/package.json
  - frontend/src/components/editor/MonacoEditor.tsx
  - frontend/src/components/editor/DiffViewer.tsx
  - frontend/src/components/editor/EditorToolbar.tsx
  - frontend/src/app/artifacts/[taskId]/[id]/page.tsx
  - frontend/src/api/client.ts
  - frontend/src/api/types.ts
autonomous: false
requirements: [EDIT-01, EDIT-02, EDIT-03, EDIT-05, EDIT-06]
user_setup: []

must_haves:
  truths:
    - "User views code with Python/PySpark syntax highlighting"
    - "User edits code in Monaco editor"
    - "User sees diff between original and edited code side-by-side"
    - "User saves edited code as new version"
    - "Editor loads without hydration errors (lazy loading)"
    - "Editor shows line numbers and minimap"
  artifacts:
    - path: "frontend/src/components/editor/MonacoEditor.tsx"
      provides: "Lazy-loaded Monaco editor wrapper"
      contains: "dynamic.*import.*monaco"
    - path: "frontend/src/components/editor/DiffViewer.tsx"
      provides: "Side-by-side diff display"
      contains: "DiffEditor"
    - path: "frontend/src/app/artifacts/[taskId]/[id]/page.tsx"
      provides: "Code editor page with toolbar"
      contains: "MonacoEditor|DiffViewer"
  key_links:
    - from: "frontend/src/app/artifacts/[taskId]/[id]/page.tsx"
      to: "/api/v1/tasks/.../artifacts/.../diff"
      via: "fetch via api client"
      pattern: "getArtifactDiff"
    - from: "frontend/src/app/artifacts/[taskId]/[id]/page.tsx"
      to: "/api/v1/tasks/.../artifacts/.../versions"
      via: "POST save version"
      pattern: "saveArtifactVersion"
---

<objective>
Build Monaco-based code editor with syntax highlighting, diff view, and version management for generated code artifacts.

Purpose: Enable users to view, edit, and version code before deployment with a proper IDE-like experience.
Output: Monaco editor component, diff viewer, updated artifact page with edit mode.
</objective>

<execution_context>
@C:/Users/parth/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/parth/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-code-editor/04-CONTEXT.md
@.planning/phases/04-code-editor/04-01-SUMMARY.md

# Existing code
@frontend/src/app/artifacts/[taskId]/[id]/page.tsx
@frontend/src/api/client.ts
@frontend/src/api/types.ts
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Monaco Editor and create lazy-loaded wrapper</name>
  <files>
    frontend/package.json
    frontend/src/components/editor/MonacoEditor.tsx
  </files>
  <action>
    Install Monaco Editor for React:
    ```bash
    cd frontend && npm install @monaco-editor/react
    ```
    
    Create lazy-loaded Monaco editor wrapper to prevent hydration issues:
    
    `frontend/src/components/editor/MonacoEditor.tsx`:
    ```tsx
    'use client';
    
    import { useEffect, useState } from 'react';
    import type { editor } from 'monaco-editor';
    
    // Dynamic import to prevent SSR issues
    const MonacoEditor = dynamic(
      () => import('@monaco-editor/react').then(mod => mod.default),
      { 
        ssr: false,
        loading: () => <LoadingSkeleton />
      }
    );
    
    import dynamic from 'next/dynamic';
    
    interface MonacoEditorProps {
      value: string;
      onChange?: (value: string) => void;
      language?: string;
      readOnly?: boolean;
      height?: string | number;
      showMinimap?: boolean;
      showLineNumbers?: boolean;
    }
    
    // Language detection helper
    function detectLanguage(code: string, explicit?: string): string {
      if (explicit) return explicit;
      if (code.includes('def ') || code.includes('import ')) return 'python';
      if (code.includes('SELECT ') || code.includes('FROM ')) return 'sql';
      if (code.includes('spark.') || code.includes('pyspark')) return 'python';
      return 'plaintext';
    }
    
    // Dark theme matching project design
    const EDITOR_THEME: editor.IStandaloneThemeData = {
      base: 'vs-dark',
      inherit: true,
      rules: [
        { token: 'comment', foreground: '6b7280' },
        { token: 'keyword', foreground: '818cf8' },
        { token: 'string', foreground: '10b981' },
        { token: 'number', foreground: 'f59e0b' },
      ],
      colors: {
        'editor.background': '#1a1a2e',
        'editor.foreground': '#e5e7eb',
        'editorLineNumber.foreground': '#4b5563',
        'editor.lineHighlightBackground': '#2d2d44',
      }
    };
    ```
    
    Use Next.js `dynamic` import with `ssr: false` to prevent hydration mismatch.
    Apply dark theme matching existing project CSS variables.
  </action>
  <verify>
    `cd frontend && npm ls @monaco-editor/react` shows installed
    `cd frontend && npm run build` succeeds (no hydration errors)
  </verify>
  <done>
    Monaco Editor installed
    Lazy-loaded wrapper component exists
    No hydration errors on build
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DiffViewer component for side-by-side comparison</name>
  <files>
    frontend/src/components/editor/DiffViewer.tsx
  </files>
  <action>
    Create side-by-side diff viewer using Monaco's built-in DiffEditor:
    
    `frontend/src/components/editor/DiffViewer.tsx`:
    ```tsx
    'use client';
    
    import { useMemo } from 'react';
    import dynamic from 'next/dynamic';
    
    const DiffEditor = dynamic(
      () => import('@monaco-editor/react').then(mod => mod.DiffEditor),
      { ssr: false, loading: () => <LoadingSkeleton /> }
    );
    
    interface DiffViewerProps {
      originalContent: string;
      modifiedContent: string;
      language?: string;
      height?: string | number;
      readOnly?: boolean;
      onModifiedChange?: (value: string) => void;
    }
    
    // Stats display component showing line changes
    function DiffStats({ stats }: { stats: { added: number; removed: number } }) {
      return (
        <div className="flex gap-md text-sm">
          <span style={{ color: 'var(--color-success)' }}>+{stats.added} added</span>
          <span style={{ color: 'var(--color-error)' }}>-{stats.removed} removed</span>
        </div>
      );
    }
    ```
    
    Features:
    - Original content on left, modified on right
    - Read-only original panel, editable modified panel
    - Line additions in green, removals in red
    - Synced scrolling between panels
    - Stats summary above viewer (from API response)
  </action>
  <verify>
    Component file exists with DiffEditor import
    TypeScript compiles without errors
  </verify>
  <done>
    DiffViewer component with side-by-side layout
    Color-coded additions/removals
    Editable right panel
  </done>
</task>

<task type="auto">
  <name>Task 3: Create EditorToolbar component</name>
  <files>
    frontend/src/components/editor/EditorToolbar.tsx
  </files>
  <action>
    Create sticky toolbar component per user decision:
    
    `frontend/src/components/editor/EditorToolbar.tsx`:
    ```tsx
    'use client';
    
    interface EditorToolbarProps {
      artifactName: string;
      artifactType: string;
      language: string;
      currentVersion: number;
      versions: ArtifactVersionSummary[];
      lastModified: string;
      author?: string;
      isEditing: boolean;
      hasUnsavedChanges: boolean;
      onToggleEditMode: () => void;
      onToggleDiffView: () => void;
      onSaveVersion: () => void;
      onVersionSelect: (version: number) => void;
    }
    ```
    
    Layout (per CONTEXT.md decisions):
    - Full-width sticky toolbar at top
    - Left: Artifact name, type badge, language indicator
    - Center: Version history dropdown (select to load different version)
    - Right: Action buttons
      - "Edit" button (enters edit mode)
      - "View Diff" button (shows diff view)
      - "Save as New Version" button (disabled if no changes)
      - "Copy" button
    
    State indicators:
      - Show "Unsaved changes" chip when hasUnsavedChanges=true
      - Show current version number
    
    Version dropdown:
      - Shows all versions from API
      - Each option: "v{N} - {timestamp}"
      - Selecting loads that version
  </action>
  <verify>
    Component exists with all required props
    TypeScript compiles
  </verify>
  <done>
    Sticky toolbar with artifact info, version selector, and action buttons
    Edit/Diff/Save buttons functional
    Version dropdown populated
  </done>
</task>

<task type="auto">
  <name>Task 4: Add API client methods for version management</name>
  <files>
    frontend/src/api/client.ts
    frontend/src/api/types.ts
  </files>
  <action>
    Add new API client methods and types:
    
    `frontend/src/api/types.ts`:
    ```typescript
    export interface ArtifactVersionSummary {
      id: string;
      version: number;
      created_at: string;
      content_hash: string | null;
      edit_message?: string;
    }
    
    export interface DiffLine {
      old_line: number | null;
      new_line: number | null;
      content: string;
      type: 'unchanged' | 'added' | 'removed';
    }
    
    export interface DiffResponse {
      from_version: number;
      to_version: number;
      from_content: string | null;
      to_content: string | null;
      diff: DiffLine[];
      stats: { added: number; removed: number; unchanged: number };
    }
    
    export interface ArtifactVersionCreateRequest {
      content: string;
      edit_message?: string;
    }
    ```
    
    `frontend/src/api/client.ts`:
    ```typescript
    // Get version history
    export async function getArtifactVersions(
      taskId: string,
      artifactId: string
    ): Promise<ArtifactVersionSummary[]>;
    
    // Get specific version
    export async function getArtifactVersion(
      taskId: string,
      artifactId: string,
      version: number
    ): Promise<ArtifactDetail>;
    
    // Save new version
    export async function saveArtifactVersion(
      taskId: string,
      artifactId: string,
      data: ArtifactVersionCreateRequest
    ): Promise<ArtifactDetail>;
    
    // Get diff between versions
    export async function getArtifactDiff(
      taskId: string,
      artifactId: string,
      fromVersion: number,
      toVersion: number
    ): Promise<DiffResponse>;
    ```
  </action>
  <verify>
    TypeScript compiles
    All functions exported from client.ts
  </verify>
  <done>
    API types defined
    Client methods for versions, diff, and save
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 5: Verify Monaco Editor integration</name>
  <files>frontend/src/components/editor/MonacoEditor.tsx</files>
  <action>
    Human verification of Monaco Editor integration. Verify all features work correctly:
    
    1. Start development server: `cd frontend && npm run dev`
    2. Navigate to artifact page: http://localhost:3000/artifacts/{taskId}/{artifactId}
    3. Check syntax highlighting works for Python/PySpark
    4. Verify line numbers and minimap are visible
    5. Test edit mode toggle
    6. Test diff view (side-by-side)
    7. Test version save
    8. Check browser console for hydration errors
  </action>
  <verify>
    All checklist items pass user visual verification
  </verify>
  <done>
    User confirms all features work correctly or reports specific issues
  </done>
  <what-built>
    Monaco Editor integration with:
    - Lazy-loaded MonacoEditor component
    - DiffViewer for side-by-side comparison
    - EditorToolbar with version selector
    - API client for version management
  </what-built>
  <how-to-verify>
    1. Run `cd frontend && npm run dev`
    2. Navigate to http://localhost:3000/artifacts/{taskId}/{artifactId}
    3. Verify:
       - Monaco editor loads with syntax highlighting
       - Line numbers and minimap visible
       - Version dropdown shows versions
       - Edit mode enables editing
       - Diff view shows side-by-side comparison
       - Save creates new version
    4. Check browser console for hydration errors (should be none)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` succeeds (no hydration errors)
2. `cd frontend && npm run dev` starts without errors
3. Manual verification of editor functionality
</verification>

<success_criteria>
- Monaco editor lazy-loads without hydration issues
- Python/PySpark syntax highlighting works
- Diff view shows side-by-side comparison (original left, edited right)
- Version history accessible via dropdown
- Save creates new artifact version
- Line numbers and minimap visible
- Sticky toolbar always visible while scrolling
</success_criteria>

<output>
After completion, create `.planning/phases/04-code-editor/04-02-SUMMARY.md`
</output>
